<script setup lang="ts">
import groupBy from "lodash.groupby";
import { simpleLangName } from "../../../config/scripts/languages";
import ExtensionFilters from "./ExtensionFilters.vue";
import ExtensionList from "./ExtensionList.vue";
import useExtensionsRepositoryQuery from "../../queries/useExtensionsRepositoryQuery";
import { computed, nextTick, onUpdated, reactive, watch } from 'vue';
import type { Extension } from "../../queries/useExtensionsRepositoryQuery";
import type { Nsfw, Sort } from "./ExtensionFilters.vue";

const { data: extensions, isLoading } = useExtensionsRepositoryQuery({
	select: (response) => {
		const values: Extension[][] = Object.values(groupBy(response, "lang"));
		values.sort(languageComparator)

		return values
	},
});

const filters = reactive({
	search: "",
	lang: [] as string[],
	nsfw: "Show all" as Nsfw,
	sort: "Ascending" as Sort,
});

function languageComparator(a: Extension[], b: Extension[]) {
	const langA = simpleLangName(a[0].lang);
	const langB = simpleLangName(b[0].lang);
	if (langA === "All" && langB === "English") {
		return -1;
	}
	if (langA === "English" && langB === "All") {
		return 1;
	}
	if (langA === "English") {
		return -1;
	}
	if (langB === "English") {
		return 1;
	}
	if (langA < langB) {
		return -1;
	}
	if (langA > langB) {
		return 1;
	}
	return 0;
}

const filteredExtensions = computed(() => {
	const filtered: Extension[][] = [];

	for (const group of (extensions.value ?? [])) {
		let filteredGroup = filters.lang.length
			? (filters.lang.includes(group[0].lang) ? group : [])
			: group;

		if (filters.search) {
			filteredGroup = filteredGroup.filter(
				(ext) =>
					ext.name.toLowerCase().includes(filters.search.toLowerCase()) ||
					ext.sources.some((source) => source.id.includes(filters.search))
			);
		}
		filteredGroup = filteredGroup.filter((ext) =>
			filters.nsfw === "Show all" ? true : ext.nsfw === (filters.nsfw === "NSFW" ? 1 : 0)
		);

		if (filters.sort && filters.sort === "Descending") {
			filteredGroup = filteredGroup.reverse();
		}
		if (filteredGroup.length) {
			filtered.push(filteredGroup);
		}
	}

	return filtered;
});

watch(extensions, async () => {
	if (window.location.hash) {
		await nextTick()
		document.getElementById(window.location.hash.substring(1))
			?.scrollIntoView({ behavior: 'smooth' });
	}
});
</script>

<template>
	<ExtensionFilters
		:extensions="extensions ?? []"
		v-model:search="filters.search"
		v-model:lang="filters.lang"
		v-model:nsfw="filters.nsfw"
		v-model:sort="filters.sort"
	/>
	<Transition name="fade" mode="out-in">
		<div class="loading" v-if="isLoading" v-loading="isLoading" style="min-height: 200px"></div>
		<ExtensionList v-else :extensions="filteredExtensions" />
	</Transition>
</template>

<style lang="stylus" scoped>
.fade-enter-active,
.fade-leave-active {
	transition: opacity 0.5s ease
}

.fade-enter-from,
.fade-leave-to {
	opacity: 0
}
</style>
